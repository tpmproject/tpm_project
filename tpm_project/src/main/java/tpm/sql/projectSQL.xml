<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tpm.project">
	
	<select id="projectAllList" resultType="tpm.project.model.ProjectDTO">
		select a.*,b.project_level from
		(tpm_project)a,(select * from tpm_project_member where member_idx=#{member_idx})b
		where a.project_idx=b.project_idx
	</select>

	<select id="projectList" parameterType="int" resultType="tpm.project.model.ProjectDTO">
		select * 
		from tpm_project 
		WHERE project_idx IN (select project_idx 
                     		  from tpm_project_member 
                      		  where member_idx=#{member_idx}) 
                      		  order by project_idx desc
	</select>
	
	<select id="project_idx" resultType="int">
	select project_idx.nextval
	from dual
	</select>
	
	<insert id="projectInsert" parameterType="tpm.project.model.ProjectDTO">
		insert into tpm_project
		values(
			#{project_idx},
			#{project_name},
			#{project_content},
			1
		)
		
	</insert>
	
	<select id="projectSearch" parameterType="tpm.project.model.ProjectDTO" resultType="tpm.project.model.TotalDTO">
		select p.project_name,p.project_content,p.project_state,c.*,co.* from
		(tpm_project)p
		left outer join
		(   select
		    c.*,w.work_idx,w.work_title,w.work_start,w.work_end,w.work_complete,
		    w.work_confirm,w.work_state,w.checklist_idx,w.checklist_content,w.checklist_state
		    from
		    (tpm_category)c
		    left outer join
		    (   select w.*,ch.checklist_idx,ch.checklist_content,ch.checklist_state from
		        (tpm_work)w
		        left outer join
		        (tpm_checklist)ch on w.work_idx=ch.work_idx)w
		    on c.category_idx=w.category_idx)c
		on p.project_idx=c.project_idx,
		
		(select
		    count(distinct c.category_idx)as category_num,
		    count(distinct w.work_idx)as work_num,
		    count(distinct w.checklist_idx)as checklist_num
		from
		    (tpm_category)c
		    left outer join
		    (   select w.*,ch.checklist_idx,ch.checklist_content,ch.checklist_state from
		        (tpm_work)w
		        left outer join
		        (tpm_checklist)ch on w.work_idx=ch.work_idx)w
		on c.category_idx=w.category_idx
		where c.project_idx=#{project_idx}
		)co
		
		where p.project_idx=#{project_idx}
		order by c.category_idx,c.work_idx,c.checklist_idx
	</select>
	
	<select id="projectWorkMember" parameterType="tpm.project.model.ProjectDTO" resultType="tpm.member.model.MemberDTO">
	select m.* from
		(	select w.work_idx from (tpm_category)c,(tpm_work)w
			where c.category_idx=w.category_idx and c.project_idx=#{project_idx})w,
		(	select wm.work_idx,m.* from (tpm_work_member)wm,(tpm_member	)m
		where wm.member_idx=m.member_idx
		order by work_idx)m
		where w.work_idx=m.work_idx
	</select>
	<update id="projectUpdate" parameterType="tpm.project.model.ProjectDTO">
		update tpm_project
		set
		project_name=#{project_name},
		project_content=#{project_content}
		where project_idx=#{project_idx}
	</update>
	
</mapper>